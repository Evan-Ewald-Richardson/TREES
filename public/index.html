<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GPX Map Viewer (Minimal)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <link rel="stylesheet" href="assets/app.css"/>
</head>
<body>
<div id="app">
  <header class="appbar">
    <div class="appbrand">
      <div class="brand-title">EVERMORE</div>
      <div class="brand-subtitle"><em>EV's Enduro Racing + MORE</em></div>
    </div>
    
    <nav class="topnav"></nav>
    
    <div class="user-auth">
      <!-- OAuth Login/Profile Area -->
      <div id="auth-bar" style="display:flex;align-items:center;gap:12px;">
        <img id="auth-avatar" src="" alt="" style="width:28px;height:28px;border-radius:50%;display:none;">
        <span id="auth-name" style="font-weight:600;"></span>
        <button id="btn-login" class="btn" style="font-size:12px; padding:6px 10px;">Sign in with Google</button>
        <button id="btn-logout" class="btn" style="display:none;font-size:12px; padding:6px 10px;">Log out</button>
      </div>
      
      <!-- Profile Area (when logged in) -->
      <div v-if="user.loggedIn" class="user-profile">
        <button @click="togglePanel('profile')" class="profile-button">
          <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
          Profile
        </button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- LEFT PANEL -->
    <div class="left">
        <!-- UPLOAD -->
        <section id="upload" class="section">
          <details class="panel" open>
            <summary>
              <div style="display:flex; align-items:center; gap:8px;">
                <!-- Upload Icon -->
                <img src="assets/icons/upload.svg" alt="Upload" class="icon" style="filter: brightness(0) saturate(100%) invert(27%) sepia(51%) saturate(2878%) hue-rotate(346deg) brightness(104%) contrast(97%);">
                Upload
              </div>
              <span class="badge neutral">files & activities</span>
            </summary>
            <div class="panel-body">
              <div class="upload-container">
                <!-- GPX Upload -->
                <div class="upload" :class="{dragover:isDragOver}"
                        @dragover.prevent="isDragOver = true"
                        @dragleave.prevent="isDragOver = false"
                        @drop.prevent="handleDrop">
                    <!-- Modern Upload Icon -->
                    <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="7,10 12,5 17,10"/>
                      <line x1="12" y1="5" x2="12" y2="15"/>
                    </svg>
                    <div style="font-weight:600; margin-bottom:4px; font-size:14px;">GPX Files</div>
                    <div class="muted" style="margin:4px 0 8px; font-size:12px;">Drag & drop or click</div>
                    <input ref="fileInput" type="file" accept=".gpx" multiple style="display:none" @change="handleFileSelect">
                    <button @click="$refs.fileInput.click()" class="btn" style="font-size:12px; padding:6px 10px;">
                      Choose Files
                    </button>
                </div>

                <!-- Strava Connect -->
                <div class="upload" style="background:var(--surface-1); border:1px solid var(--border);">
                    <!-- Strava Icon -->
                    <img src="assets/icons/strava.svg" alt="Strava" class="upload-icon" style="width:32px; height:32px;">
                    <div style="font-weight:600; margin-bottom:4px; font-size:14px;">Strava</div>
                    <div class="muted" style="margin:4px 0 8px; font-size:12px;" v-if="!strava.connected">Connect account</div>
                    <div class="muted" style="margin:4px 0 8px; font-size:12px;" v-else>{{ strava.athlete?.firstname || 'Connected' }}</div>
                    
                    <button v-if="!strava.connected" @click="stravaLogin" class="btn" style="font-size:12px; padding:6px 10px; background:#FC4C02;">
                      Connect
                    </button>
                    <button v-else @click="strava.open = !strava.open" class="btn btn-ghost" style="font-size:12px; padding:6px 10px;">
                      {{ strava.open ? 'Hide' : 'Show' }} Activities
                    </button>
                </div>
              </div>

              <!-- Status Messages -->
              <div class="muted" v-if="loading" style="margin-top:8px;">ProcessingGO</div>
              <div style="margin-top:8px; color:var(--danger)" v-if="error">{{ error }}</div>

              <!-- Strava Activities (when expanded) -->
              <div v-if="strava.connected && strava.open" style="margin-top:12px; padding-top:12px; border-top:1px solid var(--border);">
                <h4 style="margin:0 0 8px; font-size:14px; color:var(--muted);">Strava Activities</h4>
                
                <div class="row" style="align-items:center; margin-bottom:8px;">
                    <button @click="refreshStrava" class="btn btn-ghost" style="font-size:12px; padding:4px 8px;">
                      <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <polyline points="23 4 23 10 17 10"/>
                        <polyline points="1 20 1 14 7 14"/>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                      </svg>
                      Refresh
                    </button>
                    <div class="muted" style="font-size:12px;">{{ strava.perPage }} most recent</div>
                </div>

                <div v-if="strava.error" style="color:var(--danger); margin-bottom:8px; font-size:12px;">{{ strava.error }}</div>
                <div v-if="strava.loading" class="muted" style="margin-bottom:8px; font-size:12px;">LoadingGO</div>

                <div v-if="!strava.loading">
                    <div v-if="!strava.activities.length" class="muted" style="font-size:12px;">No activities found.</div>
                    
                    <div v-else>
                    <div v-for="a in strava.activities" :key="a.id"
                        style="display:flex; align-items:center; gap:8px; border:1px solid var(--border); background:var(--surface-1); border-radius:8px; padding:6px; margin-bottom:4px; font-size:12px;">
                        <div style="flex:1; min-width:0;">
                        <div style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                            {{ a.name }} <span class="muted">({{ a.sport_type || a.type }})</span>
                        </div>
                        <div class="muted" style="font-size:11px;">
                            {{ a.start_date_local || a.start_date }}
                            <span v-if="a.distance"> -+ {{ (a.distance/1000).toFixed(2) }} km</span>
                        </div>
                        </div>

                        <button @click="previewStravaActivity(a.id)" 
                                :class="strava.preview.activityId === a.id ? 'btn btn-ghost' : 'btn'"
                                style="font-size:11px; padding:4px 6px;">
                        {{ strava.preview.activityId === a.id ? 'Hide' : 'Preview' }}
                        </button>

                        <button @click="importStravaActivity(a.id)" class="btn" style="font-size:11px; padding:4px 6px;">Import</button>
                    </div>
                    </div>

                    <!-- Pagination -->
                    <div class="row" style="justify-content:space-between; margin-top:8px; font-size:12px;">
                    <button @click="prevStravaPage" :disabled="strava.page <= 1" class="btn btn-ghost" style="font-size:11px; padding:4px 8px;">Prev</button>
                    <div class="muted">Page {{ strava.page }}</div>
                    <button @click="nextStravaPage" :disabled="!strava.hasMore" class="btn btn-ghost" style="font-size:11px; padding:4px 8px;">Next</button>
                    </div>
                </div>

                <div v-if="!strava.connected && !strava.loading" class="muted" style="margin-top:8px; font-size:12px;">
                    Connect your Strava account to import activities.
                </div>
              </div>
            </div>
          </details>
        </section>

        <!-- ROUTES -->
        <section id="routes" class="section">
          <details class="panel" open>
            <summary>
              <div style="display:flex; align-items:center; gap:8px;">
                <!-- Map/Route Icon -->
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                  <circle cx="12" cy="10" r="3"/>
                </svg>
                Routes
              </div>
              <span v-if="tracks.length" class="badge success">{{ tracks.length }} loaded</span>
              <span v-else class="badge neutral">empty</span>
            </summary>
            <div class="panel-body">
              <div v-if="tracks.length > 0">

                <div class="muted" style="margin:4px 0 8px; font-size:12px;" v-if="!user.loggedIn || !selectedCourseId">
                  Login and select a course to submit routes.
                </div>

                <div class="tracks">
                    <div v-for="t in tracks" :key="t.id"
                        class="track-item"
                        style="display:flex; align-items:flex-start; gap:10px; border:1px solid var(--border); background:var(--surface-1); border-radius:10px; padding:8px;">
                    <!-- Per-track selection -->
                    <input type="checkbox" :checked="isSelected(t.id)" @change="toggleTrack(t.id)" style="margin-top:4px;" />
                    <span class="dot" :style="{color:t.color}">&bull;</span>
                    <div style="flex:1; min-width:0;">
                        <div style="font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ t.name }}</div>
                        <div class="muted">{{ t.points.length }} pts</div>

                        <!-- Segment times (per confirmed gate pair) -->
                        <div v-if="t.segmentTimes && t.segmentTimes.length" style="margin-top:6px; font-size:12px;">
                        <div v-for="seg in t.segmentTimes" :key="seg.segment" class="muted">
                            <strong>{{ seg.segment }}:</strong>
                            <span v-if="seg.timeSec !== 'N/A'">{{ seg.timeSec }}s</span>
                            <span v-else>N/A</span>
                            <span v-if="seg.valid === true" style="color:var(--success); font-weight:700; margin-left:6px;">&#10003;</span>
                            <span v-else-if="seg.valid === false" style="color:var(--danger); font-weight:700; margin-left:6px;">&#10007;</span>
                        </div>
                        </div>
                    </div>

                    <!-- Actions: Submit + Remove -->
                    <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-end;">
                      <div style="position:relative;">
                        <button @click="submitTrackToLeaderboard(t.id)" :disabled="!user.loggedIn || !selectedCourseId" class="btn">Submit</button>
                        <div v-if="(!user.loggedIn || !selectedCourseId)" @click="submitClickBlocked = true" style="position:absolute; inset:0; cursor:not-allowed;"></div>
                      </div>
                      <button @click="removeTrack(t.id)" class="btn btn-danger">Remove</button>
                    </div>
                    </div>
                </div>
              </div>

              <!-- Empty state -->
              <div v-else style="text-align:center; padding:20px;">
                <svg style="width:48px; height:48px; color:var(--muted); margin:0 auto 12px;" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                  <circle cx="12" cy="10" r="3"/>
                </svg>
                <div class="muted">No routes loaded</div>
                <div class="muted" style="font-size:12px; margin-top:4px;">Upload GPX files or connect Strava to get started</div>
              </div>
            </div>
          </details>
        </section>

        <!-- COURSES -->
        <section id="courses" class="section">
          <details class="panel" open>
            <summary>
              <div style="display:flex; align-items:center; gap:8px;">
                <!-- Course/Target Icon -->
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <circle cx="12" cy="12" r="10"/>
                  <circle cx="12" cy="12" r="6"/>
                  <circle cx="12" cy="12" r="2"/>
                </svg>
                Courses
              </div>
              <span class="muted">load, create & save</span>
            </summary>
            <div class="panel-body">
              <!-- Load Course Section (Top) -->
              <div style="margin-bottom:20px;">
                <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <h4 style="margin:0; display:flex; align-items:center; gap:6px;">
                      <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14,2 14,8 20,8"/>
                      </svg>
                      Load Course
                    </h4>
                    <div class="row" style="align-items:center;"><button v-if="selectedCourseId" @click="deselectCourse" class="btn btn-ghost" style="font-size:12px; padding:6px 10px;">Deselect</button><button @click="openCoursesModal" class="btn" style="font-size:12px; padding:6px 10px;"><svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 18l6-6-6-6"/></svg>Browse</button></div>
                </div>

                <div class="muted" style="margin-bottom:4px; font-size:12px;">Open the Courses page to select and load a course.</div>
                <div v-if="selectedCourseId" style="margin-top:8px;">
                  <div class="row" style="align-items:center; justify-content:space-between; border:1px solid var(--border); border-radius:8px; padding:8px;">
                    <div style="font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ selectedCourse?.name || ('Course ' + selectedCourseId) }}</div>
                    <span class="badge success">Loaded</span>
                  </div>
                  <div style="margin-top:8px;">
                    <div v-for="pair in gatePairs" :key="pair.pairId" class="gate-item" style="margin-bottom:8px;">
                      <div class="gate-title">
                        <div style="font-weight:600;">{{ pair.name }}</div>
                        <span class="badge neutral">Gate {{ pair.pairId }}</span>
                      </div>
                      <div style="margin-top:6px; font-size:11px;">
                        <span class="badge start">START</span>
                        <span class="coords">{{ pair.start.lat.toFixed(6) }}, {{ pair.start.lon.toFixed(6) }}</span>
                      </div>
                      <div style="margin-top:4px; font-size:11px;">
                        <span class="badge end">END</span>
                        <span class="coords">{{ pair.end.lat.toFixed(6) }}, {{ pair.end.lon.toFixed(6) }}</span>
                      </div>
                    </div>
                  </div>
                  <div v-if="activeRoutes.length" style="margin-top:12px; border-top:1px solid var(--border); padding-top:12px;">
                    <div class="row" style="align-items:center; gap:8px;">
                      <label class="muted" style="font-size:12px;">Submit route:</label>
                      <select v-model="submitRouteId" style="flex:1; padding:6px 8px; border:1px solid var(--border); border-radius:6px; font-size:12px;">
                        <option :value="null">— Select Active Route —</option>
                        <option v-for="t in activeRoutes" :key="t.id" :value="t.id">{{ t.name }}</option>
                      </select>
                      <button class="btn" :disabled="!user.loggedIn || !submitRouteId" @click="submitTrackToLeaderboard(submitRouteId)">Submit</button>
                    </div>
                    <div class="muted" v-if="!user.loggedIn" style="font-size:12px; margin-top:6px;">Login to submit to leaderboard</div>
                  </div>
                </div>
              </div>

              <!-- Gates Section (Middle) -->
              <div style="margin-bottom:20px; border-top:1px solid var(--border); padding-top:16px;">
                <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <h4 style="margin:0; display:flex; align-items:center; gap:6px;">
                      <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/>
                        <line x1="4" y1="22" x2="4" y2="15"/>
                      </svg>
                      Create Course
                    </h4>
                    <div class="row">
                      <button @click="startNewCourse" class="btn">Start New Course</button>
                    </div>
                </div>

                <div v-if="gatePairs.length === 0" class="muted" style="margin-bottom:8px; font-size:12px;">No gates yet. Click "Add Gate" to create timing points.</div>
                <div v-if="selectedCourseId && !canEditGates" class="muted" style="margin-bottom:8px; font-size:12px;">Loaded course gates are read-only. Start a new course to edit.</div>

                <div v-if="canEditGates" v-for="pair in gatePairs" :key="pair.pairId" class="gate-item" style="margin-bottom:8px;">
                    <div class="gate-title">
                    <input v-if="pair.editing" class="gate-name" :value="pair.name" @input="updatePairName(pair.pairId, $event.target.value)" placeholder="Gate pair name">
                    <div v-else style="font-weight:600;">{{ pair.name }}</div>
                    <div class="status" :class="{ok: pair.confirmed}">{{ pair.confirmed ? 'CONFIRMED' : 'EDITING' }}</div>
                    </div>

                    <div style="margin-top:6px; font-size:11px;">
                    <span class="badge start">START</span>
                    <span class="coords">{{ pair.start.lat.toFixed(6) }}, {{ pair.start.lon.toFixed(6) }}</span>
                    </div>
                    <div style="margin-top:4px; font-size:11px;">
                    <span class="badge end">END</span>
                    <span class="coords">{{ pair.end.lat.toFixed(6) }}, {{ pair.end.lon.toFixed(6) }}</span>
                    </div>

                    <div class="row" style="margin-top:8px;">
                     <button v-if="!pair.editing" @click="startEditing(pair.pairId)" class="btn btn-warn" style="font-size:11px; padding:4px 8px;">Edit</button>
                     <button v-if="pair.editing" @click="saveAndConfirmGate(pair.pairId)" class="btn" style="font-size:11px; padding:4px 8px;">Save</button>
                     <button @click="removeGatePair(pair.pairId)" class="btn btn-danger" style="font-size:11px; padding:4px 8px;">Remove</button>
                     <button v-if="pair.editing" @click="addCheckpoint(pair.pairId)" class="btn" style="font-size:11px; padding:4px 8px;">+ Point</button>
                     <button v-if="pair.editing && (pair.checkpoints?.length)" @click="removeLastCheckpoint(pair.pairId)" class="btn btn-ghost" style="font-size:11px; padding:4px 8px;">- Point</button>
                    </div>
                    <div class="muted" style="margin-top:4px; font-size:10px;">Tip: drag markers on map when editing.</div>
                </div>
                <div v-if="canEditGates" class="row" style="justify-content:flex-end; gap:8px; margin-top:8px;">
                  <button @click="addGatePair" class="btn">Add Gate</button>
                  <button @click="openPanel('save')" class="btn">Save Course</button>
                  <button @click="clearAllGates" class="btn btn-danger">Clear All Gates</button>
                </div>
              </div>

            </div>
          </details>
        </section>
        <div class="resizer" id="leftResizer" aria-label="Resize sidebar"></div>
    </div>

    <!-- RIGHT PANEL (MAP OR PROFILE) -->
    <div class="right">
        <div id="map" :style="{display: isAnyPanelOpen ? 'none' : 'block'}"></div>
        
        <!-- Profile Panel -->
        <div v-if="isProfileOpen" class="profile-right-panel">
          <div class="profile-header-right">
            <h3 style="margin:0; font-size:18px; display:flex; align-items:center; gap:8px;">
              <span>{{ user.name }}'s Profile</span>
              <span v-if="isSuperUser" class="badge success" style="text-transform:uppercase; letter-spacing:0.4px;">Admin</span>
            </h3>
            <div style="display:flex; gap:8px;">
              <button @click="fetchProfile" class="btn" style="font-size:12px; padding:6px 10px;">
                <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path d="M23 4v6h-6"/>
                  <path d="M1 20v-6h6"/>
                  <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10"/>
                  <path d="M3.51 15a9 9 0 0 0 14.85 4.36L23 14"/>
                </svg>
                Refresh
              </button>
              <button @click="closeProfileModal" class="btn btn-ghost" style="font-size:12px; padding:6px 10px;">
                Back to Map
              </button>
            </div>
          </div>
          
          <div class="profile-content-right">
            <!-- Your Courses -->
            <div class="profile-section">
              <div class="profile-panel">
                <div class="profile-panel-header">
                  <div style="display:flex; align-items:center; gap:8px;">
                    <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <circle cx="12" cy="12" r="10"/>
                      <circle cx="12" cy="12" r="6"/>
                      <circle cx="12" cy="12" r="2"/>
                    </svg>
                    Your Courses
                  </div>
                  <span class="badge neutral">{{ user.createdCourses.length }}</span>
                </div>
                <div class="profile-panel-body">
                  <div v-if="user.createdCourses.length === 0" class="profile-empty">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <circle cx="12" cy="12" r="10"/>
                      <circle cx="12" cy="12" r="6"/>
                      <circle cx="12" cy="12" r="2"/>
                    </svg>
                    <div>No courses created yet</div>
                    <div style="margin-top:4px; font-size:11px;">Create gates and save them as a course</div>
                  </div>
                  <div v-for="course in user.createdCourses" :key="course.id" class="profile-item">
                    <div class="profile-item-content">
                      <div class="profile-item-title">{{ course.name }}</div>
                      <div class="profile-item-subtitle">{{ course.gates.length }} gates &bull; {{ course.buffer_m }}m buffer</div>
                    </div>
                    <div class="profile-item-actions">
                      <button @click="loadCourseFromProfile(course.id)" class="btn" style="font-size:11px; padding:4px 8px;">Load</button>
                      <button @click="deleteCourse(course.id)" class="btn btn-danger" style="font-size:11px; padding:4px 8px;">Delete</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Leaderboard Positions -->
            <div class="profile-section">
              <div class="profile-panel">
                <div class="profile-panel-header">
                  <div style="display:flex; align-items:center; gap:8px;">
                    <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/>
                      <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/>
                      <path d="M4 22h16"/>
                      <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/>
                    </svg>
                    Leaderboard Positions
                  </div>
                  <span class="badge neutral">{{ user.leaderboardPositions.length }}</span>
                </div>
                <div class="profile-panel-body">
                  <div v-if="user.leaderboardPositions.length === 0" class="profile-empty">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/>
                      <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/>
                      <path d="M4 22h16"/>
                      <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/>
                    </svg>
                    <div>No leaderboard entries yet</div>
                    <div style="margin-top:4px; font-size:11px;">Submit a route to a course to appear on leaderboards</div>
                  </div>
                  <div v-for="pos in user.leaderboardPositions" :key="pos.id" class="profile-item">
                    <div style="display:flex; align-items:center; gap:8px;">
                      <div style="background:var(--brand-500); color:white; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:11px;">
                        #{{ pos.rank }}
                      </div>
                      <div class="profile-item-content">
                        <div class="profile-item-title">{{ pos.courseName }}</div>
                        <div class="profile-item-subtitle">{{ pos.time }}s</div>
                      </div>
                    </div>
                    <div class="profile-item-actions">
                      <button @click="loadCourseFromProfile(pos.courseId)" class="btn" style="font-size:11px; padding:4px 8px;">Load</button>
                      <button @click="deleteLeaderboardEntry(pos.id)" class="btn btn-danger" style="font-size:11px; padding:4px 8px;">Delete</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Courses Modal Panel -->
        <div v-if="isCoursesOpen" class="profile-right-panel">
          <div class="profile-header-right">
            <h3 style="margin:0; font-size:18px;">Courses</h3>
            <div style="display:flex; gap:8px;">
              <button @click="refreshCoursesGrid" class="btn btn-ghost" style="font-size:12px; padding:6px 10px;">Refresh</button>
              <button @click="closePanels" class="btn btn-ghost" style="font-size:12px; padding:6px 10px;">Back to Map</button>
            </div>
          </div>

          <div class="profile-content-right">
            <div class="profile-section">
              <div class="profile-panel">
                <div class="profile-panel-header">
                  <div style="display:flex; align-items:center; gap:8px;">
                    <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/>
                    </svg>
                    All Courses
                  </div>
                  <span class="badge neutral">{{ coursesGrid.length }}</span>
                </div>
                <div class="profile-panel-body">
                  <div v-if="!coursesGrid.length" class="profile-empty">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/>
                    </svg>
                    <div>No courses yet</div>
                  </div>

                  <!-- Tile grid -->
                  <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:12px;">
                    <div v-for="c in coursesGrid" :key="c.id"
                         style="border:1px solid var(--border); border-radius:12px; overflow:hidden; background:var(--surface-1); box-shadow:var(--shadow);">
                      
                      <div style="height:140px; background:var(--surface-2); display:flex; align-items:center; justify-content:center; overflow:hidden;">
                        <img v-if="c.image_url" :src="API(c.image_url)" alt="" style="width:100%; height:100%; object-fit:cover;">
                        <div v-else class="muted" style="font-size:12px;">No image</div>
                      </div>

                      <div style="padding:10px;">
                        <div style="font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ c.name }}</div>
                        <div class="muted" style="font-size:12px; margin:4px 0 8px; min-height:32px; overflow:hidden; text-overflow:ellipsis;">
                          {{ c.description || 'No description' }}
                        </div>

                        <div class="muted" style="font-size:12px; margin-bottom:6px;">
                          Gates: <strong>{{ courseGateCount(c) }}</strong> &bull; Buffer: <strong>{{ c.buffer_m }}m</strong>
                        </div>
                        <div class="muted" style="font-size:12px; margin-bottom:6px;">
                          Leaderboard entries: <strong>{{ courseLeaderboardCount(c) }}</strong>
                        </div>
                        <div class="muted" style="font-size:12px; margin-bottom:6px;">
                          Created: <strong>{{ formatDate(c.created_at) }}</strong>
                        </div>
                        <div class="muted" style="font-size:12px; margin-bottom:10px;">
                          Created by: <strong>{{ c.created_by || '&mdash;' }}</strong>
                        </div>

                        <!-- Mini leaderboard -->
                        <div style="display:flex; align-items:center; justify-content:space-between; font-size:12px; border:1px solid var(--border); border-radius:8px; padding:6px 8px;">
                          <div class="muted">Fastest time</div>
                          <div v-if="c.first_place" style="display:flex; gap:6px; align-items:center;">
                            <strong>{{ c.first_place.username }}</strong>
                            <span class="badge success">{{ formatSeconds(c.first_place.total_time_sec) }}</span>
                          </div>
                          <div v-else class="muted">No results yet</div>
                        </div>

                        <div style="display:flex; gap:8px; margin-top:8px; justify-content:flex-end;">
                          <button @click="loadCourseCard(c.id)" class="btn btn-ghost" style="font-size:12px; padding:6px 10px;">Load</button>
                        </div>
                      </div>
                    </div>
                  </div> <!-- /grid -->
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Save Course Modal -->
        <div v-if="isSaveOpen" class="profile-right-panel">
          <div class="profile-header-right">
            <h3 style="margin:0; font-size:18px;">Save Course</h3>
            <div style="display:flex; gap:8px;">
              <button @click="closePanels" class="btn btn-ghost" style="font-size:12px; padding:6px 10px;">Cancel</button>
            </div>
          </div>

          <div class="profile-content-right">
            <div class="profile-section">
              <div class="profile-panel">
                <div class="profile-panel-header">Details</div>
                <div class="profile-panel-body" style="display:grid; gap:10px;">
                  <input v-model="newCourse.name" placeholder="Course name">
                  <textarea v-model="newCourse.description" rows="4" placeholder="Short description"></textarea>

                  <!-- Image picker with square preview -->
                  <div style="display:flex; gap:12px; align-items:center;">
                    <div style="width:128px; height:128px; border:1px solid var(--border); border-radius:8px; background:var(--surface-2); overflow:hidden; display:flex; align-items:center; justify-content:center;">
                      <img v-if="newCourse.imagePreview" :src="newCourse.imagePreview" alt="" style="width:100%; height:100%; object-fit:cover;">
                      <div v-else class="muted" style="font-size:12px;">Preview</div>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                      <input type="file" accept="image/*" @change="onCourseImageSelect">
                      <div class="muted" style="font-size:12px;">Square works best (e.g., 512 &times; 512). PNG/JPG/WebP supported.</div>
                    </div>
                  </div>
                </div>
              </div>
              <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
                <button @click="saveAdvancedCourse" class="btn">Save</button>
              </div>
            </div>
          </div>
        </div>
    </div>
    </div>
</div>






<script type='module' src='assets/js/main.js'></script>
</body>
</html>












